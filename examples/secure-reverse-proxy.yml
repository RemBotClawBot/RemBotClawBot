# secure-reverse-proxy.yml
# Infrastructure as Code example for securing web services
# Configures Nginx with SSL, security headers, and rate limiting

# === Description ===
# This example shows how to deploy production-ready secure reverse proxy
# for OpenClaw, Forgejo, and other web services using Nginx.
#
# Features:
# - SSL/TLS with Let's Encrypt
# - Security headers (CSP, HSTS, etc.)
# - Rate limiting and DDoS protection
# - IP whitelisting for admin interfaces
# - Logging and monitoring setup

---
# Nginx Configuration Template
# Save as: /etc/nginx/sites-available/secure-proxy

server {
    listen 80;
    server_name your-domain.com;
    
    # Redirect HTTP to HTTPS
    return 301 https://$server_name$request_uri;
}

server {
    listen 443 ssl http2;
    server_name your-domain.com;
    
    # SSL Configuration
    ssl_certificate /etc/letsencrypt/live/your-domain.com/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/your-domain.com/privkey.pem;
    
    # Modern SSL settings
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_ciphers ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384:DHE-RSA-AES128-GCM-SHA256:DHE-RSA-AES256-GCM-SHA384;
    ssl_prefer_server_ciphers off;
    ssl_session_cache shared:SSL:10m;
    ssl_session_timeout 10m;
    
    # Security Headers
    add_header Strict-Transport-Security "max-age=63072000; includeSubDomains; preload" always;
    add_header X-Frame-Options "SAMEORIGIN" always;
    add_header X-Content-Type-Options "nosniff" always;
    add_header X-XSS-Protection "1; mode=block" always;
    add_header Referrer-Policy "no-referrer-when-downgrade" always;
    add_header Content-Security-Policy "default-src 'self'; script-src 'self' 'unsafe-inline' 'unsafe-eval'; style-src 'self' 'unsafe-inline'; img-src 'self' data:; font-src 'self'; connect-src 'self';" always;
    
    # Rate limiting zone
    limit_req_zone $binary_remote_addr zone=api:10m rate=10r/s;
    limit_req_status 429;
    
    # Logging
    access_log /var/log/nginx/secure-proxy-access.log json;
    error_log /var/log/nginx/secure-proxy-error.log;
    
    # Root location
    location / {
        return 404;
    }
    
    # === OpenClaw Gateway API ===
    location /api/ {
        # Internal API - restrict to trusted IPs
        allow 127.0.0.1;
        allow 192.168.1.0/24;  # Local network
        deny all;
        
        proxy_pass http://localhost:3000;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        
        # API rate limiting
        limit_req zone=api burst=20 nodelay;
        
        proxy_read_timeout 300s;
        proxy_connect_timeout 300s;
        proxy_send_timeout 300s;
    }
    
    # === Forgejo Web UI ===
    location /forgejo/ {
        proxy_pass http://localhost:3001/;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header X-Frame-Options "SAMEORIGIN";
        
        # Static file caching
        location ~* \.(jpg|jpeg|png|gif|ico|css|js)$ {
            expires 1y;
            add_header Cache-Control "public, immutable";
        }
        
        # WebSocket support for real-time features
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
    }
    
    # === Experience Portal (Nuxt App) ===
    location /experience-portal/ {
        proxy_pass http://localhost:3002/;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        
        # SPA routing support
        try_files $uri $uri/ /experience-portal/index.html;
        
        # Static assets caching
        location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg|woff|woff2|ttf|eot)$ {
            expires 1y;
            add_header Cache-Control "public, immutable";
        }
    }
    
    # === Health Check Endpoint ===
    location /health {
        access_log off;
        add_header Content-Type application/json;
        return 200 '{"status":"healthy","timestamp":"2026-02-15T14:46:00Z","services":{"openclaw":true,"forgejo":true,"nginx":true}}';
    }
    
    # === Metrics Endpoint (Prometheus) ===
    location /metrics {
        # Restrict to monitoring systems
        allow 127.0.0.1;
        allow 192.168.1.0/24;
        deny all;
        
        proxy_pass http://localhost:9090;
        proxy_set_header Host $host;
    }
    
    # === Security: Block common exploits ===
    location ~* (wp-admin|wp-login|xmlrpc) {
        deny all;
        return 444;
    }
    
    location ~* \.(bak|config|sql|fla|psd|ini|log|sh|inc|swp)$ {
        deny all;
        return 404;
    }
    
    # === Error Pages ===
    error_page 404 /404.html;
    error_page 500 502 503 504 /50x.html;
    
    location = /404.html {
        root /usr/share/nginx/html;
        internal;
    }
    
    location = /50x.html {
        root /usr/share/nginx/html;
        internal;
    }
}

# === Shell Script: Automated SSL Setup ===
# Save as: /opt/scripts/setup-letsencrypt.sh

#!/bin/bash
# setup-letsencrypt.sh - Automated SSL certificate setup with Let's Encrypt

set -euo pipefail

DOMAIN="your-domain.com"
EMAIL="admin@your-domain.com"
NGINX_CONF="/etc/nginx/sites-available/secure-proxy"
SSL_DIR="/etc/letsencrypt/live/$DOMAIN"

# Install certbot
install_certbot() {
    if ! command -v certbot &> /dev/null; then
        echo "Installing certbot..."
        apt-get update
        apt-get install -y certbot python3-certbot-nginx
    else
        echo "Certbot already installed"
    fi
}

# Configure Nginx for ACME challenge
setup_acme_challenge() {
    echo "Configuring Nginx for ACME challenge..."
    
    cat > /etc/nginx/snippets/acme-challenge.conf << 'EOF'
location /.well-known/acme-challenge/ {
    root /var/www/html;
    allow all;
}
EOF
    
    # Ensure challenge directory exists
    mkdir -p /var/www/html/.well-known/acme-challenge
    chown -R www-data:www-data /var/www/html/.well-known
    chmod -R 755 /var/www/html/.well-known
}

# Obtain SSL certificate
obtain_certificate() {
    echo "Obtaining SSL certificate for $DOMAIN..."
    
    certbot certonly \
        --webroot \
        --webroot-path /var/www/html \
        --domain "$DOMAIN" \
        --email "$EMAIL" \
        --agree-tos \
        --non-interactive \
        --keep-until-expiring
}

# Update Nginx configuration
update_nginx_config() {
    echo "Updating Nginx configuration..."
    
    # Backup original config
    cp "$NGINX_CONF" "$NGINX_CONF.backup.$(date +%Y%m%d)"
    
    # Patch SSL paths
    sed -i "s|ssl_certificate .*|ssl_certificate $SSL_DIR/fullchain.pem;|" "$NGINX_CONF"
    sed -i "s|ssl_certificate_key .*|ssl_certificate_key $SSL_DIR/privkey.pem;|" "$NGINX_CONF"
    
    # Test configuration
    nginx -t || {
        echo "Nginx configuration test failed. Restoring backup..."
        cp "$NGINX_CONF.backup.$(date +%Y%m%d)" "$NGINX_CONF"
        exit 1
    }
}

# Setup auto-renewal
setup_renewal() {
    echo "Setting up automatic renewal..."
    
    # Create renewal script
    cat > /etc/cron.weekly/letsencrypt-renew << 'EOF'
#!/bin/bash
certbot renew --quiet --post-hook "systemctl reload nginx"
EOF
    
    chmod +x /etc/cron.weekly/letsencrypt-renew
    
    # Test renewal
    certbot renew --dry-run
}

main() {
    echo "=== SSL Certificate Setup ==="
    echo "Domain: $DOMAIN"
    echo "Email: $EMAIL"
    echo ""
    
    install_certbot
    setup_acme_challenge
    obtain_certificate
    update_nginx_config
    setup_renewal
    
    echo ""
    echo "=== Setup Complete ==="
    echo ""
    echo "1. Certificate obtained and stored in: $SSL_DIR"
    echo "2. Nginx configuration updated"
    echo "3. Automatic renewal configured via cron"
    echo ""
    echo "Restart Nginx to apply changes:"
    echo "sudo systemctl restart nginx"
    echo ""
}

if [[ "${BASH_SOURCE[0]}" == "${0}" ]]; then
    main "$@"
fi

# === Security Hardening Script ===
# Save as: /opt/scripts/harden-nginx.sh

#!/bin/bash
# harden-nginx.sh - Security hardening for Nginx web server

set -euo pipefail

NGINX_CONF="/etc/nginx/nginx.conf"
SITES_DIR="/etc/nginx/sites-available"

# Backup original configuration
backup_config() {
    echo "Backing up Nginx configuration..."
    cp "$NGINX_CONF" "$NGINX_CONF.backup.$(date +%Y%m%d)"
    
    for site in "$SITES_DIR"/*; do
        [ -f "$site" ] && cp "$site" "$site.backup.$(date +%Y%m%d)"
    done
}

# Apply security headers globally
apply_security_headers() {
    echo "Applying security headers..."
    
    cat > /etc/nginx/conf.d/security-headers.conf << 'EOF'
# Security Headers
add_header X-Frame-Options "SAMEORIGIN" always;
add_header X-Content-Type-Options "nosniff" always;
add_header X-XSS-Protection "1; mode=block" always;
add_header Referrer-Policy "strict-origin-when-cross-origin" always;
add_header Permissions-Policy "geolocation=(), microphone=(), camera=()" always;
add_header X-Permitted-Cross-Domain-Policies "none" always;

# CSP Example (adjust per application)
# add_header Content-Security-Policy "default-src 'self'; script-src 'self' 'unsafe-inline' 'unsafe-eval'; style-src 'self' 'unsafe-inline'; img-src 'self' data: https:; font-src 'self' data:; connect-src 'self';" always;
EOF
}

# Configure logging
configure_logging() {
    echo "Configuring enhanced logging..."
    
    # Create JSON log format
    cat > /etc/nginx/conf.d/log-format.conf << 'EOF'
log_format json_combined escape=json
    '{'
    '"time_local":"$time_local",'
    '"remote_addr":"$remote_addr",'
    '"remote_user":"$remote_user",'
    '"request":"$request",'
    '"status": "$status",'
    '"body_bytes_sent":"$body_bytes_sent",'
    '"request_time":"$request_time",'
    '"http_referrer":"$http_referer",'
    '"http_user_agent":"$http_user_agent",'
    '"http_x_forwarded_for":"$http_x_forwarded_for",'
    '"server_name":"$server_name",'
    '"upstream_addr":"$upstream_addr",'
    '"upstream_status":"$upstream_status",'
    '"upstream_response_time":"$upstream_response_time"'
    '}';
EOF
    
    # Update main config to use JSON logging
    sed -i 's/access_log .*/access_log \/var\/log\/nginx\/access.log json_combined;/' "$NGINX_CONF"
}

# Set connection limits
set_connection_limits() {
    echo "Setting connection limits..."
    
    cat > /etc/nginx/conf.d/limits.conf << 'EOF'
# Rate limiting zones
limit_req_zone $binary_remote_addr zone=login:10m rate=5r/m;
limit_req_zone $binary_remote_addr zone=api:10m rate=10r/s;

# Connection limits
limit_conn_zone $binary_remote_addr zone=addr:10m;

# Default limits
limit_req_status 429;
limit_conn_status 503;
EOF
}

# Disable server tokens
disable_server_tokens() {
    echo "Disabling server tokens..."
    
    if grep -q "server_tokens" "$NGINX_CONF"; then
        sed -i 's/server_tokens.*/server_tokens off;/' "$NGINX_CONF"
    else
        echo "server_tokens off;" >> "$NGINX_CONF"
    fi
}

# Configure timeouts
configure_timeouts() {
    echo "Configuring timeouts..."
    
    cat > /etc/nginx/conf.d/timeouts.conf << 'EOF'
# Timeout configurations
client_body_timeout 10s;
client_header_timeout 10s;
keepalive_timeout 65s;
send_timeout 10s;
EOF
}

# Secure default configuration
secure_default_config() {
    echo "Securing default configuration..."
    
    # Remove default site if it exists
    rm -f /etc/nginx/sites-enabled/default 2>/dev/null || true
    
    # Create catch-all default site
    cat > /etc/nginx/sites-available/default-catch-all << 'EOF'
server {
    listen 80 default_server;
    listen [::]:80 default_server;
    
    server_name _;
    
    # Deny all traffic to default server
    location / {
        return 444;
    }
    
    # Allow health checks
    location /health {
        access_log off;
        return 200 "healthy\n";
    }
}
EOF
    
    ln -sf /etc/nginx/sites-available/default-catch-all \
           /etc/nginx/sites-enabled/default-catch-all
}

# Test and reload
test_and_reload() {
    echo "Testing configuration..."
    nginx -t || {
        echo "Configuration test failed. Restoring backup..."
        restore_backup
        exit 1
    }
    
    echo "Reloading Nginx..."
    systemctl reload nginx
    
    echo "Hardening complete!"
}

restore_backup() {
    echo "Restoring from backup..."
    cp "$NGINX_CONF.backup.$(date +%Y%m%d)" "$NGINX_CONF"
    systemctl reload nginx
}

main() {
    echo "=== Nginx Security Hardening ==="
    echo ""
    
    backup_config
    apply_security_headers
    configure_logging
    set_connection_limits
    disable_server_tokens
    configure_timeouts
    secure_default_config
    test_and_reload
    
    echo ""
    echo "=== Summary ==="
    echo "✅ Security headers configured"
    echo "✅ JSON logging enabled"
    echo "✅ Rate limiting zones created"
    echo "✅ Server tokens hidden"
    echo "✅ Timeouts optimized"
    echo "✅ Default site secured"
    echo ""
    echo "Access logs now contain structured JSON data for analysis."
    echo "Rate limiting protects against brute force attacks."
    echo ""
}

if [[ "${BASH_SOURCE[0]}" == "${0}" ]]; then
    main "$@"
fi